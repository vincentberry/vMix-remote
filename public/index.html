<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="shortcut icon" href="./assets/img/favicon.png">
    <!--
        <script src="../js/notifications.js" type="text/javascript"></script>
        FONTS
    // <link rel="stylesheet" href="../css/fonts/Roboto-Regular.ttf">-->

    <!--meta SEO-->
    <meta name="description" content="">
    <meta name="author" content="">
    <meta name="keyword" content="">

    <title>REMOTE VMIX</title>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="./assets/style/index.css" />

</head>

<body>
    <nav>
        <div>
            <div class="list">
                <label for="vmix_connect">Choisir le vmix:</label>
                <select name="vmix_connect" id="vmix_connect">
                    <option value="test">--Please choose an option--</option>
                </select>
            </div>
            <h1 id="projetName"></h1>
            <div class="statut_vmix_contener">
                <div id="streaming" class="statut_vmix">
                    <h1>Streaming</h1>
                </div>
                <div id="recording" class="statut_vmix">
                    <h1>Recording</h1>
                </div>
                <div id="external" class="statut_vmix">
                    <h1>external</h1>
                </div>
                <div id="fullscreen" class="statut_vmix">
                    <h1>fullscreen</h1>
                </div>
            </div>

        </div>
    </nav>

    <!-- <div class="loader" id = loader></div> -->
    <main>

        <!-- <div class="input_video program">
    <div class="video">
       
        <h2>1</h2>
        <div class="type">
            <img src="./assets/icon/album.svg" alt="">
            <h1>Cameddddddddddddddddddddddddddddddddddddddddra 1</h1>
        </div>
 
    </div>
    <div class="overlay">
        <button class="preview">1</button>
        <button>2</button>
        <button>3</button>
        <button>4</button>
        <button class="menu"></button>
        
    </div>
</div> -->
        <button onclick="vMix_ActiveInput(PreviewInterfaceWeb)">CUT</button>
        <button onclick="vMix_Fade(PreviewInterfaceWeb)">FACE</button>
        <div id="output-container"></div>
        <div id="audioSourcesContainer"></div>

        <!-- Script JavaScript pour récupérer le fichier XML et générer les éléments -->
        <script>
            var PreviewInterfaceWeb = ""
            // Fonction pour charger le fichier XML depuis l'API
            function chargerFichierXML() {
                const urlAPI = 'http://192.168.0.40:85/test/api/' + document.getElementById('vmix_connect').value;
                fetch(urlAPI)
                    .then(response => response.text())
                    .then(data => {
                        if (document.getElementById('vmix_connect').value === "0") {
                            // Récupérer l'élément <select> par son ID
                            var selectElement = document.getElementById('vmix_connect');
                            var files = JSON.parse(data);

                            const outputContainer = document.getElementById('output-container');
                            // Supprimer les éléments existants dans le conteneur de sortie
                            while (outputContainer.firstChild) {
                                outputContainer.removeChild(outputContainer.firstChild);
                            }
                            // Ajouter les options au <select>
                            // Ajouter les options au <select> uniquement si elles n'existent pas déjà
                            for (var i = 0; i < files.length; i++) {
                                var fileName = files[i];

                                // Vérifier si l'option existe déjà
                                if (!optionExists(fileName)) {
                                    console.log("new connection")
                                    var option = document.createElement('option');
                                    option.value = fileName;
                                    option.textContent = fileName;
                                    selectElement.appendChild(option);
                                }
                            }
                            // Fonction pour vérifier si une option existe déjà
                            function optionExists(value) {
                                for (var i = 0; i < selectElement.options.length; i++) {
                                    if (selectElement.options[i].value === value) {
                                        return true;
                                    }
                                }
                                return false;
                            }

                        } else {
                            convertirXMLenHTML(data);
                            processAudioSources(data);
                        }
                    })
                    .catch(error => console.error('Erreur de chargement du fichier XML:', error));
            }

            // Fonction pour convertir le XML en HTML et l'ajouter à la page
            function convertirXMLenHTML(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');

                const inputs = xmlDoc.querySelectorAll('input');

                const outputContainer = document.getElementById('output-container');
                const previewNumber = parseInt(xmlDoc.querySelector('preview').textContent);
                const activeNumber = parseInt(xmlDoc.querySelector('active').textContent);
                document.getElementById('projetName').textContent = xmlDoc.querySelector('preset').textContent;

                updateCheckboxClass('streaming', JSON.parse(xmlDoc.querySelector('streaming').textContent.trim().toLowerCase()));
                updateCheckboxClass('recording', JSON.parse(xmlDoc.querySelector('recording').textContent.trim().toLowerCase()));
                updateCheckboxClass('external', JSON.parse(xmlDoc.querySelector('external').textContent.trim().toLowerCase()));
                updateCheckboxClass('fullscreen', JSON.parse(xmlDoc.querySelector('fullscreen').textContent.trim().toLowerCase()));


                PreviewInterfaceWeb = previewNumber;
                // Supprimer les éléments existants dans le conteneur de sortie
                while (outputContainer.firstChild) {
                    outputContainer.removeChild(outputContainer.firstChild);
                }
                const overlays = xmlDoc.querySelectorAll('overlay');
                overlays.forEach(overlay => {
                    const overlayNumber1 = parseInt(overlay.getAttribute('number'));

                });

                inputs.forEach(input => {
                    const key = input.getAttribute('key');
                    const number = input.getAttribute('number');
                    const type = input.getAttribute('type');
                    const title = input.getAttribute('title');

                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'input_video';
                    inputDiv.id = key;

                    const videoDiv = document.createElement('div');
                    videoDiv.className = 'video';

                    // Ajouter la classe "preview" si le nombre correspond à previewNumber
                    if (parseInt(number) === previewNumber) {
                        videoDiv.classList.add('preview');
                    }
                    // Ajouter la classe "program" si le nombre correspond à previewNumber
                    if (parseInt(number) === activeNumber) {
                        videoDiv.classList.add('program');
                    }
                    videoDiv.name = "input_" + number;
                    videoDiv.innerHTML = `
                <h2>${number}</h2>
                <div class="type">
                    <img src="./assets/icon/${type}.svg" alt="${type}">
                    <h1>${title}</h1>
                </div>
            `;

                    // Ajouter l'événement onclick
                    videoDiv.onclick = function () {
                        vMix_PreviewInput(key)
                    };

                    const overlayDiv = document.createElement('div');
                    overlayDiv.className = 'overlay';

                    overlays.forEach(overlay => {
                        const overlayNumber = parseInt(overlay.getAttribute('number'));
                        const overlayContent = overlay.textContent.trim(); // Contenu de la balise overlay

                        if (overlayNumber < 5) {
                            varClass = "";
                            if (overlayContent === number) {
                                varClass = 'program';

                            }
                            if (overlay.getAttribute('preview') === 'True' && overlayContent === number) {
                                varClass = 'preview';

                            }
                            // Ajouter la classe "preview" aux boutons correspondant à previewNumber
                            overlayDiv.innerHTML += `
                            <button
                            class="${varClass} a${overlayNumber}" style="grid-area: grid_${overlayNumber};"
                            id="overlay_${overlayNumber}_id_${key}" 
                            onclick="vMix_OverlayToggle(${overlayNumber},${number})
                            ">${overlayNumber}
                            </button>`;
                        }

                    });

                    overlayDiv.innerHTML += `<button onclick="" class="menu grid_menu"></button>`;

                    inputDiv.appendChild(videoDiv);
                    inputDiv.appendChild(overlayDiv);

                    outputContainer.appendChild(inputDiv);
                });
            }

            // Charger le fichier XML et générer les éléments HTML au chargement de la page
            window.onload = chargerFichierXML;
          //  setInterval(chargerFichierXML, 10000);

            //Add New InputVideo
            function AddInputVideo() {

            }

            // Fonction pour traiter les sources audio
            function processAudioSources(xmlString) {
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                const audioSources = xmlDoc.querySelectorAll('input[muted]');

                // Récupérer le conteneur pour les sources audio
                const container = document.getElementById('audioSourcesContainer');

                // Parcourir toutes les sources audio
                audioSources.forEach(audioSource => {
                    // Récupérer la clé unique de la source audio
                    const key = audioSource.getAttribute('key');

                    // Vérifier si une source audio avec la même clé existe déjà dans le conteneur
                    const existingAudioSource = document.querySelector(`.audio-source[data-key="${key}"]`);

                    // Si la source audio existe déjà, la mettre à jour
                    if (existingAudioSource) {
                        // Mettre à jour les informations nécessaires
                        existingAudioSource.innerHTML = getAudioSourceHTML(audioSource);
                    } else {
                        // Créer une nouvelle div pour la source audio
                        const newDivElement = document.createElement('div');
                        newDivElement.className = 'audio-source';
                        newDivElement.setAttribute('data-key', key);

                        // Remplir la div avec les informations
                        newDivElement.innerHTML = getAudioSourceHTML(audioSource);

                        // Ajouter la nouvelle div au conteneur
                        container.appendChild(newDivElement);
                    }
                });

                // Supprimer les sources audio qui n'existent plus
                const existingAudioSources = document.querySelectorAll('.audio-source');
                existingAudioSources.forEach(existingAudioSource => {
                    const key = existingAudioSource.getAttribute('data-key');
                    const matchingAudioSource = xmlDoc.querySelector(`input[key="${key}"]`);
                    if (!matchingAudioSource) {
                        existingAudioSource.remove();
                    }
                });
            }

            // Fonction pour obtenir le HTML d'une source audio à partir de l'élément XML
            function getAudioSourceHTML(audioSource) {
                const key = audioSource.getAttribute('key');
                const title = audioSource.getAttribute('title');
                const muted = audioSource.getAttribute('muted') === 'True';
                const volume = parseFloat(audioSource.getAttribute('volume'));
                const gainDb = parseFloat(audioSource.getAttribute('gainDb'));
                const balance = parseFloat(audioSource.getAttribute('balance'));
                const soloPFL = audioSource.getAttribute('soloPFL') === 'True';
                const solo = audioSource.getAttribute('solo') === 'True';
                const audiobusses = audioSource.getAttribute('audiobusses');
                const meterF1 = parseFloat(audioSource.getAttribute('meterF1'));
                const meterF2 = parseFloat(audioSource.getAttribute('meterF2'));

                return `
                    <h2>${title}</h2>
                    <div class="button">
                        <p class="muted ${muted}" onclick="vMix_Audio('${key}')"></p>
                        <p class="solo ${solo}" onclick="vMix_Solo('${key}')">S</p>
                        <p>Audiobusses: ${audiobusses}</p>
                        <p>Balance: ${balance}</p>
                    </div>
                    <div class="range">
                        <label for="volume-${key}">Volume: ${Math.floor(volume)}%</label>
                        <input type="range" id="volume-${key}" value="${volume}" min="0" max="100" step="1" onclick="vMix_SetVolume('${key}')">
                    </div>
                    <div class="range" >
                        <label for="gainDb-${key}">gainDb: +${Math.floor(gainDb)}db</label>
                        <input type="range" id="gainDb-${key}" value="${gainDb}" min="0" max="24" step="1" onclick="vMix_SetGain('${key}')">
                    </div>
                `;
            }



            //Api Vmix Command
            function vMix_OverlayToggle(overlay, key) {
                // URL de votre endpoint de serveur
                const url = 'flyValue=OverlayInput' + overlay +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue=0' +
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function vMix_PreviewInput(key) {
                // URL de votre endpoint de serveur
                const url = 'flyValue=PreviewInput' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue=0' +
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function vMix_ActiveInput(key) {

                // URL de votre endpoint de serveur
                const url = 'flyValue=ActiveInput' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue=0' +
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function vMix_Fade(key) {

                // URL de votre endpoint de serveur
                const url = 'flyValue=Fade' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue=500' +
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function vMix_SetVolume(key) {
                // Récupérer l'élément <input> par son ID
                const volumeInput = document.getElementById(`volume-${key}`);


                
                // URL de votre endpoint de serveur
                const url = 'flyValue=SetVolume' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue='+ volumeInput.value +
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function vMix_SetGain(key) {
                // Récupérer l'élément <input> par son ID
                const volumeInput = document.getElementById(`gainDb-${key}`);

                // URL de votre endpoint de serveur
                const url = 'flyValue=SetGain' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue='+ volumeInput.value +
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function vMix_Audio(key) {
                // Récupérer l'élément <input> par son ID

                // URL de votre endpoint de serveur
                const url = 'flyValue=Audio' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue=0'+
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            
            function vMix_Solo(key) {
                // Récupérer l'élément <input> par son ID

                // URL de votre endpoint de serveur
                const url = 'flyValue=Solo' +
                    '&inputValue=' + encodeURIComponent(key) +
                    '&durationValue=0'+
                    '&mixValue=0';

                ApiVmixSend(url)
            }

            function ApiVmixSend(req) {

                req = 'http://192.168.0.40:85/test/command?' + req
                // Effectuer la requête GET
                fetch(req)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`La requête a échoué avec le code ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Traitez la réponse du serveur si nécessaire
                        console.log('Réponse du serveur :', data);
                        AlertPopup(data)
                    })
                    .catch(error => {
                        // Gérez les erreurs ici
                        console.error('Erreur lors de l\'envoi de la requête au serveur :', error.message);
                    });
            }

            function AlertPopup(data) {
                window.alert('Commande envoyée avec succès ! Interface ce mettra à jours dans 10s Max !');
            }

            // Fonction pour ajouter ou supprimer une classe en fonction de l'état de la case à cocher
            function updateCheckboxClass(checkboxId, className) {


                if (className) {
                    // La case à cocher est cochée, ajouter la classe
                    document.getElementById(checkboxId).classList.add('true');
                } else {
                    // La case à cocher n'est pas cochée, supprimer la classe
                    document.getElementById(checkboxId).classList.remove('true');
                }
            }
        </script>
    </main>

</body>